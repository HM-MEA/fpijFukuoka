# ５章　外部リソースを扱う

 　「外部リソース」を使用する場合は，ガベージコレクション(GC)は開発者の責任の範囲です。

* 外部リソースとは?
  * データベース接続
  * ファイル
  * ソケット
  * ネイティブリソース

- 参考
 - [JDK close()メソッド一覧 - GrepCode](http://grepcode.com/search?query=close%28%29&start=0&r=repository.grepcode.com%24java%24root&entity=method&n=)

## 5.1 リソースの解放

ベンカット・スブラマニアン（著者）の経験： 

* **アプリケーションの使用率が高くなると落ちるアプリケーション**
  * 開発者はその問題を「正常に動きます…ほとんどの場合は。」と説明した
  * finalize()でデータベースの接続を開放していたため，JVMは十分なメモリを持っているのでGCを走らせる必要がないと判断していた
  * ファイナライザは滅多に呼ばれず外部リソースが溜まり，動作が不安定になっていた

JJUG CCC 2015 Springのケース：

* **JUGGの発表資料「ほんとうに便利だった業務で使えるJava SE8新機能」でファイル処理のリソースの開放漏れ？**
  * 業務にJava8を導入したJUGGの発表が話題に！
  * 発表翌日（2015/04/12）に，「33ページのコードにはリソース解放漏れがあります」と指摘が発生
  * 登壇者は「33Pで説明したいことの本質ではなかったため、意図して省きました。セッションでは39Pで説明しました」とコメントしました

    ```java
    Files.lines(Paths.get("sample.txt"))
             .forEach(string -> System.out.println(string));
    ```

僕のケース：

* **監視バッチでORA-01000:最大オープン・カーソル数を超えましたが発生**
  * 5秒間隔でOracleのDBにアクセスして，データを監視するバッチ
  * UT（単体テスト）でコードレビューを担当し，「帰社前に起動して，翌朝例外がなければ良いんじゃない」「何もありませんでした」「OK，コンピュータ」
  * IT（結合テスト）で「ORA-01000:最大オープン・カーソル数を超えましたが発生」が発生していると，プロパーから指摘
  * 反省文
  * 原因は，単純なリソースの開放漏れ
  * なぜ気づかなかったのか？ try-catchのcatchで例外を潰していた…

- 参考
 - [ほんとうに便利だった業務で使えるJava SE8新機能（JJUG CCC 2015 Spring）, p.33 - SlideShare](http://www.slideshare.net/yuukifukuda378/ss-46878413)
 - [だから、あれほどFiles#lines(Path)を使うときはtry-with-resourcesでちゃんと包めといったのに… #jjug #ccc_f2 - mike-neckのブログ](http://mike-neck.hatenadiary.com/entry/2015/04/12/210000)

### 5.1.1 問題を覗いてみる

[resource/fpij/FileWriterExample.java](https://github.com/k--kato/fpijFukuoka/blob/feature/Chapter05/Chapter05/resources/fpij/FileWriterExample.java)

### 5.1.2 リソースを閉じる

### 5.1.3 確実にリソースを開放する

### 5.1.4 自動リソース管理（ARM）の使用

## 5.2 ラムダ式でリソース解放

### 5.2.1 リソース開放を行うクラスの準備

### 5.2.2 高階関数の使用

### 5.2.3 インスタンス化違法に使用

## 5.3 ロックの管理

## 5.4 簡潔な例外テストの生成

### 5.4.1 try/catchで例外テスト

### 5.4.2 アノテーションを使った例外テスト

### 5.4.3 例外テストにラムダ式を使用

### 5.4.4 テストの実行

## 5.5 まとめ


